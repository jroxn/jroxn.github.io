<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="devops故障排错, Linux Python Shell Devops Kubernetes Hadoop">
    <meta name="description" content="任何值的拥有的都是值得等待的">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>devops故障排错 | Roxn</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/jquery/jquery.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Roxn</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Roxn</div>
        <div class="logo-desc">
            
            任何值的拥有的都是值得等待的
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        

    </ul>
</div>


        </div>

    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/medias/drawing-bed/featureimages/17.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">devops故障排错</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/linux/">
                                <span class="chip bg-color">linux</span>
                            </a>
                        
                            <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
                                <span class="chip bg-color">学习笔记</span>
                            </a>
                        
                            <a href="/tags/%E7%B3%BB%E7%BB%9F/">
                                <span class="chip bg-color">系统</span>
                            </a>
                        
                            <a href="/tags/devops/">
                                <span class="chip bg-color">devops</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/notes/" class="post-category">
                                notes
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-08-21
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-08-10
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    18k
                </div>
                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/prism/prism.css">
        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <!-- 文章头部设置 --> 

<h1 id="故障排除的最佳实践"><a href="#故障排除的最佳实践" class="headerlink" title="故障排除的最佳实践"></a>故障排除的最佳实践</h1><h2 id="1-1-划分问题空间"><a href="#1-1-划分问题空间" class="headerlink" title="1.1 划分问题空间"></a>1.1 划分问题空间</h2><p>首先玩一个游戏1~100中间随机一个数字73。让玩家去猜这个数字。<br>第一类人：50，75，62，68，71，73。<br>第二类人：1，2，3…73。<br>第三类人：73。…。23，1，59…73。<br>你可以看到，找到正确答案只猜了6次。如果从1开始递加需要猜73次。如果随机猜有可能要遍历所有的数字才能找到答案。<br>&emsp;&emsp;这个方法适用于所有的故障排除。面对问题，一些人从可能产生问题的原因列表的底层开始，一步一步解决问题，另外一些人选择随机测试直到幸运地找到原因。一位优秀的故障排除人员选择的每一项测试的结果都会排除一类原因，而不是一个原因，将故障分而治之。划分问题空间之后，即使一项测试不能找到故障的根本原因，测试结果最少也能排除掉几个可能的原因。<br>&emsp;&emsp;例如，如果我尝试用浏览器访问一个网站，但是请求超时，此时我想测试是网站的原因还是我的网络连接有问题，但我不会立即去查看网线是否没有插好，而是访问一两个通常都很稳定的其他<a href="www.baidu.com">网站</a>。如果别的网站能正常加载，就可以确定我的网络连接正常，从而省去一系列本地网络测试。<br>&emsp;&emsp;当你和团队中的其他人协作排除故障时，也会在团队成员之间划分问题空间，没有比跟踪一个问题的时候发现有人也在做相同的测试更坏的事情了。当你在团队环境下着手解决一个问题时，要给每个人分配不同的测试并保证一旦某个人排除了一个原因，能及时把结果传达给其他人。</p>
<h2 id="1-2-协同工作时的良好沟通"><a href="#1-2-协同工作时的良好沟通" class="headerlink" title="1.2 协同工作时的良好沟通"></a>1.2 协同工作时的良好沟通</h2><p>&emsp;&emsp;建立良好的沟通方法是团队排除故障的最大挑战之一。如果没有良好的沟通，两个人不会意识到正在解决相同的问题，一个人会重复排查别人已经检查过的问题。更糟糕的是，人们误解了说明，让问题变得愈加严重。<br>直接对话：运团队人员通常坐在一个区域，方便沟通。<br>电子邮件：不需要立即解决的问题可以选择电子邮件<br>QQ、钉钉、微信、等群聊天软件：优点个人之间可以私密聊天，群里面可以共享信息。可以保留聊天记录。<br>其他的备用方案：电话会议等。</p>
<h2 id="1-3-首选快速、简单的测试，而不是缓慢、复杂的测试"><a href="#1-3-首选快速、简单的测试，而不是缓慢、复杂的测试" class="headerlink" title="1.3 首选快速、简单的测试，而不是缓慢、复杂的测试"></a>1.3 首选快速、简单的测试，而不是缓慢、复杂的测试</h2><p>&emsp;&emsp;如果每个问题都有一系列井然有序的测试集合，那就太棒了。然而，通常你会遇到各种各样的原因，这些原因看起来都像是问题的根源所在。你很难知道应该先尝试哪个，一个好的原则是：当你可以执行两个一样好的测试的时候，首选快速或简单的，而不是缓慢或复杂的。<br>&emsp;&emsp;如果你们团队的宕机时间是用金钱衡量的，那么尽可能快地定位问题的原因非常重要。例如，当一个Web服务器宕机的时候，有很多不同的方法可以解决这个问题。但是，如果你从ping服务器的方法开始尝试，那么就是在使用一种相当快的方法断定服务器是否连通了网络。如果无法ping通服务器，你就可以着手处理如何让服务器恢复网络连接。若是能ping通，则可以进行更进一步的故障排除过程，损失的只不过是几秒钟时间而已。<br>&emsp;&emsp;在团队合作的情景下有个优势是可以很容易同时进行多个测试。在这种情况下，让一个员工做缓慢、复杂的测试而其他人专注更短、更简单的测试是合理的。只要团队成员之间具备良好的沟通，你们就能迅速定位到问题的根本原因。<br>&emsp;&emsp;尽管应该首选快速、简单的测试，但如果有缓慢的测试可以在几乎无人监视的情况下执行，那么做一下慢测试也无妨。因为启动慢测试之后，测试运行期间你可以去做别的事情。同样的思路也适用于那些需要花费时间的故障排除过程。例如，故障排除中有一步是提交一个工单或者给支持人员发送某种通知，当启动这些流程之后，你就可以将注意力转移到其他更需要关注的任务当中。<br>&emsp;&emsp;另外一个大问题是，网络是否接通？通常一些大问题的原因都很简单。网络和电源线的连接经常会松动，非常轻微的推动就足以让服务器断开网络连接。如果你离系统设备非常近，可以查看下线缆是否接通，快速查看线缆连接比坐在电脑前一分钟等待端口扫描的结果要好得多。</p>
<h2 id="1-4-多尝试过去的解决方案"><a href="#1-4-多尝试过去的解决方案" class="headerlink" title="1.4 多尝试过去的解决方案"></a>1.4 多尝试过去的解决方案</h2><p>&emsp;&emsp;事实上大部分问题都发生了不止一次。某些人拥有快速划分问题根源能力的原因是他们以前多次碰到过同样的问题。你接触的问题越多，你就越能成为一个更好、更快的故障排除人员。<br>&emsp;&emsp;解决问题时经常会遇到以前碰到过的症状。努力回忆上次是什么原因造成的这个问题，采取了什么样的步骤来隔离问题。多数情况下，问题症状一样，造成问题的原因也相同，如果你能识别出这个症状，就能非常快速地解决问题。俗话说得好，如果它走起路来像鸭子且叫声也像鸭子，那它很可能就是只鸭子。<br>&emsp;&emsp;然而，有时候它并不是鸭子。我曾经见过某些人在听到任何相似的症状时就采用使用过的解决方案去解决问题，完全不再听取任何其他的描述。实际情况是，完全不同的问题经常也可以产生相同的症状。尤其是那些表面症状。例如，登入服务器的会话有延迟并且看起来非常缓慢。在服务器负载很高或者网络连接不佳的情况下都会出现这样的情况。Nmap（一个很好用的端口扫描工具）会报告一个端口被过滤，如果防火墙阻塞了这个端口或者某个路由器配置错误的话。如果过早地把注意力放到过去的某个解决方案中，会让自己对问题产生偏见，从而更难找到造成问题的真正原因。<br>&emsp;&emsp;关键的一点是即使你用之前的解决方案指导故障的排除过程，也务必验证你的假设。如果你记得上次隔离问题的一些方法，那么这次你应该能用一个测试很快的验证问题，如果测试结果不同，就准备好采取别的解决方法吧。</p>
<h2 id="1-5-记录问题和解决方案"><a href="#1-5-记录问题和解决方案" class="headerlink" title="1.5 记录问题和解决方案"></a>1.5 记录问题和解决方案</h2><p>&emsp;&emsp;如我所说过的，大部分问题都发生了不止一次。利用这个事实的最好方法之一是记录问题及其解决方案。许多人将这个过程称为事后析误。一个问题解决以后，参与解决问题的人聚集在一起记录哪里出了差错，每个人分别采取了什么步骤来隔离问题，相应的结果是什么。事后剖析的最后确定问题的根本原因，更理想的情况是，实施进一步的方案去防止此类问题再发生。<br>&emsp;&emsp;尽管事后析误会占用每个人的时间，但是有很多理由值得这么去做。主要原因是，如果同样的症状下次再出现，会很难想起上次解决这个问题时做的每一件事情。情急之下，你能记起的只有你曾经碰到过这个问题。如果你能找到相应的事后析误记录，就会立即找到一个排除故障的步骤列表去隔离问题。<br>&emsp;&emsp;记录问题的过程也会让团队中的每一位成员成为更好的问题解决者。团队中的初级成员从资深成员的经历中受益，每个人一起学习新的工具和技术。更重要的是，如果问题的解决方法记录下来，团队中的初级成员很容易自己就能解决问题。这意味着，你在度假或者睡觉时就会少被打扰了。<br>&emsp;&emsp;若运用得当，事后析误将成为一笔有价值的财富。倘若运用不当，则它们引发的问题会比能解决的还要多。讨论和记录故障排除方法与过程非常棒，但你必须追溯到问题的根本原因。一旦问题消失，确实要花费很多时间和努力去查阅日志来追查问题的根源。很多时候一个团队只能做到描述问题的症状是什么，采取了什么措施消除了这个问题。团队经常通过重启系统或者服务就解决了问题。如果不能隔离问题的根源，很可能会一次又一次地遇到相同的问题。<br>&emsp;&emsp;当然，找到问题的根源仅在你想采取措施防止问题重现时有用。一旦你掌握了问题的根源，就可以想出解决问题的方法和能解决问题的人员。这说起来容易，但若不了解问题的根源，可能会再次碰到这个问题。最坏的情形是，你会认为从根本上解决问题从而一劳永逸的努力是白费的。<br>&emsp;&emsp;一些团队会有相反的问题。他们喜欢用事后析误去分析问题根源，但只是为了知道应该责备谁，事后析误在这种环境下就会变得有防御性，且常带有侵略性，这最终会起到相反的效果。当事后析误变得只有指责，人们不大可能去参与它，而很可能隐瞒事实，尤其是问题可能牵连到自己时。最后，即使你发现应该责备某人，但是可能并没有找到问题的根本原因。当你不得不排除一个新问题的时候，这就形成了一个更加紊乱的环境。在这样的环境中，人们的关注点不是解决手边的问题，而是做很多工作去证明出现问题的原因在于你，而不是我。<br>&emsp;&emsp;最后，有些人非常喜欢事后析误以至于他们在问题解决之前就开始这么做了。当你身处于一个危机当中的时候，你的关注点应该在手上的问题和你要隔离问题而采用的故障排除手段。这时候了解问题的根源还为时尚早，追问<strong>我们怎么做才能让这样的事不再发生</strong>也没有意义。如果你解决过复杂的问题，你就知道，在解决问题过程中，你认为可能的问题根源会不断地发生改变。通常排除故障压力很大，需要极度的专注，尤其是当故障花费公司的金钱的时候，任何注意力分散都意味着解决问题的时间会更久。<br>&emsp;&emsp;即使你已经鉴定出问题的根本原因，最好给每个人足够的时间冷静下来，镇定一下，在你计划长期的解决问题方案之前认真思考刚才发生了什么。缺少那些额外的时间，你很可能会碰到反对意见，这将要么推迟问题的解决，要么造成比他们解决的问题还多的问题。</p>
<h2 id="1-6-了解改动"><a href="#1-6-了解改动" class="headerlink" title="1.6 了解改动"></a>1.6 了解改动</h2><p>&emsp;&emsp;系统问题的一个最大来源是改动。如果系统已经流畅地运行了很久，突然出现了一个问题，你首先应该问的是：哪里发生了改动？如果系统一直都不稳定，就不必把新的改动作为问题的来源之一。但是对于运行一向稳定的系统来说，在所有其他因素相同的情况下，改动的内容应该作为你进行故障排除的第一目标。鉴定和排除对系统的改动将会显著加快排除故障的过程。<br>&emsp;&emsp;尽管对系统的更改可能是问题的来源，但你如果没有办法追踪到更改，就很可能无法更快地解决问题。如果你缺乏追踪所做更改的方法，就应该认真地考虑寻找一个方法，尤其是当你的系统曾经很稳定时。没有比收到问题报警更好的了，”<strong>Jim在问题发生的那段时间提交了代码</strong>“，这可以迅速跟踪到问题。没有比在稳定的系统上发现一个问题，当想要知道对系统做了什么改动时却无从得知更糟糕的事情了。<br>&emsp;&emsp;即使通过某些方法能了解到改动的内容，你最好还是要求自己每次只做一个改动。如果能在问题发生时指出之前的一个改动，会很容易隔离问题。若同时更改了10段代码和3个配置文件就很难隔离问题。我曾经遇到一些团队用维护窗口作为追踪变更的方法，结果很多不相关的信息都涌了出来。问题在于在这样的维护窗口下发生问题的时候，很难隔离问题的根本原因。<br>&emsp;&emsp;如果有一个系统专门用来记录改动那就太棒了，这个系统最好还允许回滚那些引发问题的更改。如果没有别的问题，若你能把所有的改动回滚到问题发生之前，而问题依旧存在，就排除了一个主要的假设，然后可以继续做其他测试。即使你能回滚所有的改动，最好仍然每次只做一个改动。回滚多个改动可能会解决问题，但你仍然不得不遍历每个改动去找到问题的源头。<br>&emsp;&emsp;上面说了这么多，但改动不总是造成问题的原因。事实上，我曾经见过”更改了什么”这个问题在故障排除过程中转移了很多注意力。像所有其他故障排除哲学一样，验证你认为是改动造成的问题的假设，而不要在刚碰到问题时就回滚全部改动。</p>
<h2 id="1-7-了解系统如何工作"><a href="#1-7-了解系统如何工作" class="headerlink" title="1.7 了解系统如何工作"></a>1.7 了解系统如何工作</h2><p>&emsp;&emsp;这么多年来，作为一个系统管理员我了解到的一点是遇到问题时，每个人都会指责他们知之甚少的技术。在我职业生涯的一段时期内，DNS成了所有网络问题的替罪羊。我不知道为什么会出现这样的局面，不过自打我在那里起，我们的DNS服务器一直都很稳定，但出现网络问题的时候，人们总会问：”是不是DNS宕机了？”我注意到指责DNS有问题的人就是那些对DNS了解最少的人。我的解决方案是在公司内部开设一个自愿参加的课程，主讲DNS如何工作。在那之后，我注意到参加过课程的人在遇到网络问题时不再指责DNS(但少数未参加该课程的人仍然是老样子)。<br>&emsp;&emsp;要点是，本能地去指责自己不熟悉的技术这个毛病排除故障的人员和其他人也有。如果你知道所排查故障的系统如何工作，你将会是一个高效的问题解决者。从解决Linux问题的角度讲，这意味着对TCP/IP、DNS、Linux进程、编程和内存管理都要有较深的理解。本书将以故障排除为上下文来解释这些主题，不过这些都是非常不错的主题，即使不为了排除故障也应该了解。<br>&emsp;&emsp;你会发现，对系统如何工作了解得越多，解决系统问题的速度就越快，同时也会发现你对问题的预感更加准确。这也能帮助你避免做无用功。你将不用执行很多测试就可以排除引起某个问题的一系列原因。</p>
<h2 id="1-8-谨慎使用Internet"><a href="#1-8-谨慎使用Internet" class="headerlink" title="1.8 谨慎使用Internet"></a>1.8 谨慎使用Internet</h2><p>&emsp;&emsp;排除故障时，Internet是一个非常宝贵的资源。你可能不是世界上第一个看到某条错误消息的人。很有可能有人已经碰到过和你一样的问题，而且你有可能搜索到可行的解决方法。<br>&emsp;&emsp;使用Internet排除故障的挑战是在开始网络搜索之前，需要对问题有正确、清晰的理解。假如你的服务器没有连入网络，而你只是在搜索引擎中输入”server not on network”(服务器脱机)，很可能不会得到有用的结果。一旦你采取某些故障排除措施缩小了问题的范围，并且对问题有了更清晰的认识，就能使用具体、有针对性的搜索词条帮助你解决问题。<br>&emsp;&emsp;当问题故障排除的过程中包含了详细的错误码或短语时，Internet是最有帮助的。描述特定问题的错误码特别方便，因为很容易搜索到相关信息，即使你不了解错误码的含义。一般在某个论坛能找到为你解释错误码含义以及应该如何处理这些错误的人或知识库。如果程序输出的错误信息足够详尽，那么它们也可以作为帮助你解决问题的一个很好的来源。<br>&emsp;&emsp;使用网络搜索的另一个危险是：如果对问题了解得不够深入或者没有使用特定的关键词搜索，你就会得到大量无价值的信息，并且错误的问题诊断步骤将会让你离产生问题的根源更远。你还可能会从一群一无所知的人那里得到很多建议。总是从问题本身出发，尤其是要确保在复制、粘贴任何命令或代码之前对它们了如指掌。</p>
<h2 id="1-9-抵制重启"><a href="#1-9-抵制重启" class="headerlink" title="1.9 抵制重启"></a>1.9 抵制重启</h2><p>&emsp;&emsp;在Windows 95时代，重启系统通常是修复问题的最好办法。虽然Windows 95时代已经久远，甚至现在我们都不再使用Windows作为服务器，但是重启操作在一些人的脑海中已经根深蒂固，当发生故障的时候，他们的第一反应就是重启服务或者重启硬件设备。<br>&emsp;&emsp;使用重启操作修复问题最危险之处不在于它不能工作，而在于有时候重启系统确实修复了故障。危险之处在于如果通过重启操作修复了问题，你仍然不能识别出问题的根本原因。因为问题消失了无法继续测试，所以可能再也不能找出产生问题的原因。在问题不存在的情况下，寻找问题的原因确实非常困难。如果你不能找出问题的根本原因，几乎可以保证你在晚些时候还会遇到相同的问题。<br>&emsp;&emsp;不要误解我的意思，我不是说排除故障时，永远不能重启硬件设备或者重启服务。我的意思是你应该把重启作为最后的手段。在开始问题诊断之前，尝试获得所有与排除故障相关的数据，以防问题消失。这可能是一个取巧的策略，尤其是在问题需要花费金钱并且你的老板或者客户尖叫着让你重启机器看看问题是否解决时。但是，请坚持立场，如果你觉得老板或者客户不高兴，那就等同样的问题再次出现时再说吧。</p>
<h1 id="服务器为什么这么慢？CPU、RAM、I-O问题"><a href="#服务器为什么这么慢？CPU、RAM、I-O问题" class="headerlink" title="服务器为什么这么慢？CPU、RAM、I/O问题"></a>服务器为什么这么慢？CPU、RAM、I/O问题</h1><p>&emsp;&emsp;尽管服务器的绝大部分问题都与网络相关，但是还有一类问题仅与本地服务器相关。让这个问题变得棘手的是：本地服务器问题和网络问题经常表现出相同的征兆。事实上，服务器本地的问题会导致网络问题，反过来也一样。本章将会介绍专门出现在本机上的问题，而将影响网络的问题留到第5章介绍。<br>&emsp;&emsp;几乎DevOps团队中的所有成员都遇到过性能不好或响应缓慢的主机，不论是试图查出为什么最近一次提交比之前慢很多的开发者，在代码部署到生产环境之前努力执行负载测试的QA工程师，还是需要确定是否应该购买更多RAM、CPU或运行速度更快的磁盘的系统管理员。这些技术甚至可以帮助你排除Linux桌面系统中的负载问题。<br>&emsp;&emsp;关于主机最常见的一个问题可能是性能太差，甚至都无法响应。通常，网络故障会引发这个问题，但本章将会介绍一些本地故障排除工具，借助这些工具可以分辨出网络过载和机器过载之间的区别。<br>&emsp;&emsp;机器运行缓慢通常是由于消耗了太多系统特定的资源。系统的主要资源包括CPU、RAM、磁盘I/O以及网络（将在第5章介绍）。过度使用这些资源的任何一种都会让系统陷入困境，此时唯一的解决方法就是————重启。不过，如果能登录到系统之中，则可以借助大量工具确定问题的起因。</p>
<h2 id="2-1系统负载"><a href="#2-1系统负载" class="headerlink" title="2.1系统负载"></a>2.1系统负载</h2><p>&emsp;&emsp;解决引起系统运行缓慢的问题时，平均系统负载可能是最先用到的基本度量标准。在排除系统运行缓慢的问题时，通常我执行的第一条命令是<code>uptime</code>:  </p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">uptime</span>
<span class="token number">13</span>:35:03 up <span class="token number">103</span> days, <span class="token number">8</span> min, <span class="token number">5</span> users, load average: <span class="token number">2.03</span>, <span class="token number">20.17</span>, <span class="token number">15.09</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>&emsp;&emsp;<code>load average</code>后面的3个数字<code>2.03</code>、<code>20.17</code>和<code>15.09</code>分别代表了<code>1分钟</code>、<code>5分钟</code>和<code>15分钟</code>内机器的平均负载。一个系统的平均负载等于处于运行或者不可打扰状态进程的平均数。可运行的进程要么正在使用CPU，要么正在等待使用CPU；不可打扰状态的进程都在等待IO响应。<br>&emsp;&emsp;平均负载为1的单CPU系统意味着这个CPU处于恒定负载。如果单CPU系统的平均负载是4，那么这个系统处于它可承受负载能力的4倍，所以3/4的进程都在等待资源。一个系统的平均负载不会因为你所拥有的CPU数量而更改，所以，如果具备两个CPU的系统的平均负载是1，那么其中一个CPU一直处于满负荷状态，也就是说，系统处于50%的负载状态。所以，负载状态为1的单CPU系统与负载状态为4的四CPU系统使用资源的量一样。<br>&emsp;&emsp;1分钟、5分钟、15分钟的平均负载描述了相对时间内负载的平均值，这些值在确定系统当前状态时非常有用。1分钟内的平均负载会让你对系统当前所处的状态有一个清晰的认识，所以在前面这个例子中，你能看到服务器在过去的1分钟内负载为2，但是在过去的5分钟内平均负载却飙升到了20。前15分钟内，负载平均值是15。由此可知，机器在过去的15分钟内处于高负载的状态，而且5分钟前系统负载又开始增长，但是现在已经减弱。让我们将它与一个完全不同的平均负载做个对比。  </p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">uptime</span>
05:11:52 up <span class="token number">20</span> days, <span class="token number">55</span> min, <span class="token number">2</span> users, load average: <span class="token number">17.29</span>, <span class="token number">0.12</span>, <span class="token number">0.01</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>&emsp;&emsp;在这个例子中，5分钟内和15分钟内的平均负载都很低，但是1分钟内的平均负载却很高，所以我知道负载的飙升相对而言发生在最近。在这种情况下，通常我会连续运行多次<code>uptime</code>命令（或者使用<code>top</code>命令，马上我就会讲到这个工具）来观察负载是持续上升还是正在下降。</p>
<p>什么是高平均负载</p>
<p>&emsp;&emsp;一个值得研究的问题是：平均负载多少算高？简单的回答是”这取决于产生高负载的原因”。因为负载描述了正在使用资源的活动进程的平均数量，所以负载的飙升透露了很多信息。明确负载是CPU密集型（等待CPU资源的进程）、RAM密集型（尤其是，频繁使用的RAM被移入了交换区）还是I/O密集型（争夺磁盘或网络I/O资源的进程）非常重要。<br>&emsp;&emsp;例如，如果运行的一个应用程序在不同的时间点产生大量的同步线程，这些线程会同时启动，你可能会看到负载飙升到20、40或者更高，它们在竞争系统资源。随着这些进程逐渐完成，负载就会降下来。<br>&emsp;&emsp;通常CPU密集型的系统会比I/O密集型的系统响应度更高。我见过数以百计CPU密集型的系统，我仍然可以在这些系统上运行故障排除工具而且具有良好的响应时间。我也见过IO负载相对较低的I/O密集型系统，只是登录这些系统就需要花费一段时间，因为它们的磁盘IO完全饱和了。用尽RAM资源的系统通常与I/O密集型的系统表现相同，因为一旦系统开始使用磁盘上的交换存储，它就会消耗磁盘资源，导致进程逐渐变慢直至停止。</p>
<h2 id="2-2-使用top命令解决负载问题"><a href="#2-2-使用top命令解决负载问题" class="headerlink" title="2.2 使用top命令解决负载问题"></a>2.2 使用top命令解决负载问题</h2><p>&emsp;&emsp;当需要解决高负载问题的时候，我第一个想到的工具是top命令。在命令行输入top命令并按下Enter键后，马上就能看到大量的系统信息（见图2-1）。这些数据都会不断更新，所以你能看到系统的实时信息，包括系统启动了多久、负载平均值、系统中总共有多少进程正在运行、总共有多少内存、使用了多少内存、还剩多少内存，最后还包含系统的进程列表以及它们占用的资源数量。使用top命令可能无法看到系统当前运行的所有进程，因为无法将它们都显示在屏幕上。top命令默认排序方式是按照进程的CPU使用情况从上到下排序，所以可以一眼就能看到哪些进程正在消耗CPU资源。</p>
<p><img src="/medias/drawing-bed/oops/0.jpg"></p>
<p>&emsp;&emsp;那么如果发现一个进程占用了全部CPU资源，你想要终止这个进程，该怎么做呢？top命令输出的第一列是PID，它代表程序的进程ID————系统赋给每个进程的唯一ID。想要<code>终止某个进程</code>，只需按下<code>K</code>按键，然后输入想要终止的<code>PID</code>，最后当系统提示该进程将会终止于<code>signal 15</code>时，按下<code>Enter</code>键即可。<br>&emsp;&emsp;默认情况下top命令在非交互式模式下运行，如果不需要看显示在屏幕外的信息，那一切都还好。如果想要看到top命令的完整输出，或者想将这些信息都重定向到文件中，那么你可以在批处理模式下运行这个命令。-b选项可以开启批处理模式，-n选项可以控制在退出top命令之前，刷新信息多少次。例如，想看到完整的输出，仅需运行一次top命令，输入如下命令:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">top</span> -b -n l<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果想要将这些信息存储到名为top_output的文件中，那么请输入如下命令:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">top</span> -b -n <span class="token number">1</span> <span class="token operator">></span> top_output<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果想要查看top命令的输出，同时将该输出写入文件，那么你可以使用便捷的命令行工具 tee:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">top</span> -b -n <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">tee</span> top_output<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="2-2-1-了解top命令的输出"><a href="#2-2-1-了解top命令的输出" class="headerlink" title="2.2.1 了解top命令的输出"></a>2.2.1 了解top命令的输出</h3><p>&emsp;&emsp;使用top命令来排除系统负载问题时，基本步骤是检查top的输出，借此明确耗尽了哪些资源（CPU、RAM还是磁盘I/O）。一旦清楚了这个问题，就可以尝试检查到底是哪些进程大量消耗了这些资源。首先，检查系统中top命令的标准输出:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">top</span> - <span class="token number">14</span>:08:25 up <span class="token number">38</span> days，8:02，1 user，load average: <span class="token number">1.70</span>，1.77，1.68
Tasks: <span class="token number">107</span> total， <span class="token number">3</span> running，104 sleeping， <span class="token number">0</span> stopped，0 zombie
Cpu<span class="token punctuation">(</span>s<span class="token punctuation">)</span>: <span class="token number">11.4</span>%us，29.6%sy，0.0%ni，58.3%id，.7%wa，0.0%hi，0.0%si，0.8%st
Mem:  1024176k total，997408k used， 26768k free， 85520k buffers
Swap: 1004052k total，  4360k used，999692k free，286040k cached
PID   <span class="token environment constant">USER</span>   PR NI  VIRT  RES  SHR  S %CPU %MEM     TINE+  COMWAND
<span class="token number">9463</span>  mysql  <span class="token number">16</span>  <span class="token number">0</span>  686m  ll1m <span class="token number">3328</span> S   <span class="token number">53</span>  <span class="token number">5.5</span> <span class="token number">569</span>:17.64  mysqld
<span class="token number">18749</span> nagios <span class="token number">16</span>  <span class="token number">0</span>  140m  134m <span class="token number">1868</span> S   <span class="token number">12</span>  <span class="token number">6.6</span>   <span class="token number">1345</span>:01  nagios2db_status
<span class="token number">24636</span> nagios <span class="token number">17</span>  <span class="token number">0</span> <span class="token number">34660</span>  10m   <span class="token number">712</span> S    <span class="token number">8</span>  <span class="token number">0.5</span>   <span class="token number">1195</span>:15  nagios
<span class="token number">22442</span> nagios <span class="token number">24</span>  <span class="token number">0</span>  <span class="token number">6048</span>  <span class="token number">2024</span> <span class="token number">1452</span> S    <span class="token number">8</span>  <span class="token number">0.1</span>   <span class="token number">0</span>:00.04  check_time.pl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>&emsp;&emsp;top命令输出的第一行与你之前见到的uptime命令的输出一致。正如你在这个例子中看到的，对于这台拥有4个CPU的机器来说，系统负载并不大。<br><code>top - 14:08:25 up 38 days，8:02，1 user，1oad average: 1.70，1.77，1.68</code><br>&emsp;&emsp;不过除了标准的系统负载，top命令还为你提供了额外的度量标准。例如，Cpu(s)这一行提供了当前CPU运行情况的信息:<br><code>Cpu(s): 11.4%us，29.6%sy，0.0%ni，58.3%id，0.7%wa，0.0%hi，0.0%si，0.0%st</code><br>&emsp;&emsp;如果你不清楚这些缩写代表什么，那么它们对你毫无意义，所以我将它们都列在下面:  </p>
<ul>
<li><input disabled="" type="checkbox"> us: 用户CPU时间<br>运行非优雅的用户进程所占CPU时间的百分比（优雅，英文”nicing”，是指一个进程允许你根据其他进程更改优先级）。  </li>
<li><input disabled="" type="checkbox"> sy: 系统CPU时间<br>运行内核和内核进程所占CPU时间的百分比。  </li>
<li><input disabled="" type="checkbox"> ni: 优雅CPU时间<br>如果更改过一些进程的优先级，这个指标能够告诉你它们所占CPU时间的百分比。  </li>
<li><input disabled="" type="checkbox"> id: CPU空闲时间<br>这是你希望具备很高数值的度量指标中的一个。它代表了CPU的空闲时间比。如果系统运行缓慢，但是这个指标特别高，那么你就可以确定问题的原因不是高CPU负载。  </li>
<li><input disabled="" type="checkbox"> wa: I/O等待<br>这个数字代表了CPU时间用在等待执行I/O操作所占的百分比。当你解决运行缓慢的系统问题的时候，这是一个非常有价值的度量指标，因为如果这个数值很低，那么就能轻松排除磁盘或者网络I/O的问题。  </li>
<li><input disabled="" type="checkbox"> hi: 硬件中断<br>CPU用于处理硬件中断所占时间的百分比。  </li>
<li><input disabled="" type="checkbox"> si: 软件中断<br>CPU用在处理软件中断所占时间的百分比。  </li>
<li><input disabled="" type="checkbox"> st: 流逝的时间<br>如果你正在运行虚拟机，这个度量指标会告诉你虚拟机中执行的其他任务所占CPU时间的百分比。  </li>
</ul>
<p>&emsp;&emsp;在前面的例子中，你可以看到系统有超过50%的空闲时间，这与机器具备4个CPU、系统负载为1.70的指标相匹配。当你处理一个运行缓慢的系统的时候，首先要观察的度量指标之一就是I/O等待时间，它可以用来排除磁盘I/O的问题。如果I/O等待时间很低，那么可以看看CPU空闲时间百分比；如果I/O等待时间很高，那么下一步就是确定是什么因素导致I/O等待时间所占的比重这么高，这一点我马上就会讲到。如果I/O等待和CPU空闲时间百分比都很低，那么很可能会看到一个非常高的用户时间百分比，所以你必须确定是什么原因导致了这么高的用户时间百分比。如果I/O等待时间所占百分比很低，而空闲时间百分比很高，那么你就知道系统运行缓慢不是CPU资源的原因，而应该从别的地方找原因。这可能意味着应该查看网络问题或者Web服务器的问题，或者查看MySQL查询缓慢的问题等。</p>
<h3 id="2-2-2-解决高用户时间的问题"><a href="#2-2-2-解决高用户时间的问题" class="headerlink" title="2.2.2 解决高用户时间的问题"></a>2.2.2 解决高用户时间的问题</h3><p>&emsp;&emsp;解决故障的过程中一个常见而又相对简单的问题是，由用户CPU时间百分比高引起的高负载问题。这很常见，因为服务器上的服务很可能会占系统负载的绝大部分，而且这些服务都是用户进程。如果发现<code>用户时间百分比高</code> 但<code>I/O等待时间百分比却很低</code>，很显然你需要确定系统中哪一个<code>进程占用了</code>如此<code>大量的CPU资源</code>。默认情况下，top命令会按照各个进程CPU使用率由高到低排序。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">  PID   <span class="token environment constant">USER</span> PR NI  VIRT  RES  SHR S %CPU %MEM     TIME+  COMMAND
 <span class="token number">9463</span>  mysql <span class="token number">16</span>  <span class="token number">0</span>  686m 111m <span class="token number">3328</span> S   <span class="token number">53</span>  <span class="token number">5.5</span> <span class="token number">569</span>:17.64  mysqld
<span class="token number">18749</span> nagios  <span class="token number">1</span>  <span class="token number">0</span>  140m 134m <span class="token number">1868</span> S   <span class="token number">12</span>  <span class="token number">6.6</span>   <span class="token number">1345</span>:01  nagios2db_status
<span class="token number">24636</span> nagios <span class="token number">17</span>  <span class="token number">0</span> <span class="token number">34660</span>  10m  <span class="token number">712</span> S    <span class="token number">8</span>  <span class="token number">0.5</span>   <span class="token number">1195</span>:15  nagios
<span class="token number">22442</span> nagios <span class="token number">24</span>  <span class="token number">0</span>  <span class="token number">6048</span> <span class="token number">2024</span> <span class="token number">1452</span> S    <span class="token number">8</span>  <span class="token number">0.1</span>   <span class="token number">0</span>:00.04  check_time.pl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>&emsp;&emsp;在这个例子中，mysqld进程消耗了53%的CPU时间，nagios2db_status进程消耗了12%的CPU时间。注意，这个数字代表的是所占单个CPU的百分比，所以如果你拥有一台具备4个CPU的机器，可能会看到多个进程都耗了99%的CPU时间。<br>&emsp;&emsp;你会看到大部分高CPU负载的情况都是由于CPU 被一个、两个或者很多个进程消耗殆尽。任何一种情况都很容易确定，因为在第一种情况下，top命令输出中前一两个进程都有非常高的CPU百分比，而其余进程所占CPU百分比相对很低，此时，解决方法就是终止大量使用CPU资源的进程（按K键，然后输入对应进程的PID）。<br>&emsp;&emsp;在多进程的情况下，你可能让系统做了太多事。比如说，在Web服务器中可能有大量Apache进程，还有cron中运行的部分日志解析脚本。这些进程可能会消耗差不多等量的CPU资源。这种问题的解决方案从长期来看相当复杂。以Web服务器为例，你的确需要运行全部Apache进程，同时你可能还需要日志解析工具。在短期内，你可以终止（或推迟）一些进程直到负载降低，但是从长期来看，你可能需要考虑增加系统资源或者将这些功能分拆到多台服务器上。</p>
<h3 id="2-2-3-解决内存不足的问题"><a href="#2-2-3-解决内存不足的问题" class="headerlink" title="2.2.3 解决内存不足的问题"></a>2.2.3 解决内存不足的问题</h3><p>&emsp;&emsp;top输出中的以下两行提供了非常有价值的RAM使用情况的信息。在处理特定的系统问题之前，排除内存问题非常重要。</p>
<pre class="line-numbers language-none"><code class="language-none">Mem: 1024176k total，997408k used， 26768k free， 85520k buffers
Swap:1004052k total，  4360k used，999692k free，286040k cached<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>&emsp;&emsp;第1行告诉我们有多少物理内存可用、占用了多少内存、空闲多少内存以及缓存了多少内存。第2行为我们提供了相似的信息，交换存储以及Linux文件缓存使用了多少RAM。一眼看上去会以为系统内存快要耗尽了，因为系统仅显示有26768KB空闲内存。不少故障排除人员都会被输出中与Linux文件缓存相关的已用和空闲的信息误导。一旦Linux将一个文件载入到RAM中，当程序用完这个文件的时候，不需要将它从RAM中移除。如果还有可用的RAM，Linux将会在RAM中缓存这个文件，这样如果一个程序再次访问这个文件，访问速度将会得到大幅提升。如果系统的确需要为活动的进程提供RAM，那RAM中将不会缓存这么多文件。由于文件缓存的存在，通常在服务器运行相当长的一段时间后，都会显示仅有少量RAM空闲，而其余的都被缓存占用。<br>&emsp;&emsp;想要找出进程到底真正使用了多少RAM，你必须刨除RAM中的文件缓存。正如你所看到的示例代码一样，在已用的997408KB的RAM中，有286040KB的RAM被文件缓存占用，所以这就是说实际上仅使用了711368KB的RAM。在这个例子中，系统仍然有大量可用的内存资源，几乎没有使用任何交换存储。即便你的确看到使用了一些交换存储，这也不足以作为问题的征兆。如果一个进程转为空闲状态，Linux通常会将它占用的RAM释放，供其他进程使用。辨别是否耗尽了RAM的一个好方法是查看文件缓存。如果实际用的内存减去文件缓存的值很大，同时交换存储的值也很高，很可能的确有内存问题。<br>&emsp;&emsp;如果真的发现了内存问题，下一步就是确定哪些进程消耗了RAM。top默认按照CPU的使用率排序，所以你需要将其改为按照RAM使用率来排序。保持top的打开状态，然后按下M键。这就会让所有进程按照RAM的使用率排序。</p>
<pre class="line-numbers language-none"><code class="language-none">  PID USER   PR NI  VIRT﹒RES  SHR S %CPU %MEM   TIME+  COMMAND
18749 nagios 16  0  140m 134m 1868 S   12  6.6 1345:01  nagios2db_status
 9463 mysql  16  0  686m 111m 3328 S   53  5.5  569:17  mysqld
24636 nagios 17  0 34660  10m  712 S    8  0.5 1195:15  nagios
22442 nagios 24  0   048 2024 1452 S    8  0.1 0:00.04  check_time.pl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>&emsp;&emsp;注意%MEM这一列，会看到前几个进程占用了大量RAM。如果你找到了大量使用RAM的进程，可以终止它们，或者根据程序，通过专门的故障排除方法来寻找是什么原因导致这些进程占用了大量RAM。<br><strong>注意</strong><br>&emsp;&emsp;<em>实际上top命令的输出可以根据任何列排序。想要更改top输出的排序方式，按F键进入选择排序列的界面。在按下对应特定列的按键之后（比如，K对应CPU列），再按Enter键就能回到top的输出界面。</em><br>&emsp;&emsp;Linux内核也有一个内存耗尽（OOM）终结者，如果低内存导致系统运行危险，它就会介入。当系统内存快要耗尽的时候，OOM终结者就会开始终止进程。有些情况下，终止的可能是占用大量RAM的进程，但它并不能保证不会终止未占用大量RAM的进程。有的时候它也会终止像sshd这样的程序或者其他进程，而不是真正的罪魁祸首。很多时候，OOM终止了一些进程之后，系统就会变得不大稳定，所以你不得不重启机器以确保所有的系统进程都在正常运行。如果OOM终结者介入了，在/var/log/syslog中你会看到如下行:</p>
<pre class="line-numbers language-none"><code class="language-none">1228419127.32453.1704.hostname:2,S:Out of Memory: Kil1ed process 21389 (java).
1228419127.32453_1710.hostname:2,S:Out of Memory: Killed process 21389 (java).<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="2-2-4-解决高I-O等待时间问题"><a href="#2-2-4-解决高I-O等待时间问题" class="headerlink" title="2.2.4 解决高I/O等待时间问题"></a>2.2.4 解决高I/O等待时间问题</h3><p>&emsp;&emsp;当你看到IO等待时间所占CPU时间的比重很高的时候，首先需要检查的就是机器是否正在大量使用交换空间。因为硬盘操作的速度远远低于RAM，所以当系统内存耗尽，开始使用交换空间的时候，系统的性能会受到严重响。任何想要访问硬盘的操作都要完成与硬盘的I/O交换。所以，故障排除的第一步是看内存是否耗尽，如果是，先解决这个问题。如果还有大量可用的RAM，你需要明确哪个进程占用了大部分I/O操作。<br>&emsp;&emsp;有的时候很难弄明白到底是哪个进程占用了大量I/O资源，但是如果系统中存在多个分区，你可以缩小范围，找到哪个分区正在执行大量IO操作。想要做到这一点，需要使用iostat程序，基于Red Hat和基于Debian的系统的sysstat包中都提供了这个程序。如果你的机器没有安装，可以通过包管理工具来安装。<br>&emsp;&emsp;在解决问题之前，你最好先安装好这个程序。安装了这个程序后，就可以不带任何参数运行iostat，观察系统的整体情况。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> iostat
Linux <span class="token number">2.6</span>.24-19-server <span class="token punctuation">(</span>hostname<span class="token punctuation">)</span>   01/31/2009
avg-cpu:  %user  %nice  %system  %iowait  %steal  %idle
           <span class="token number">5.73</span>   <span class="token number">0.07</span>     <span class="token number">2.03</span>     <span class="token number">0.53</span>    <span class="token number">0.00</span>  <span class="token number">91.64</span>
Device:  tps  Blk_read/s  B1k_wrtn/s  B1k_read  Blk_wrtn
sda     <span class="token number">9.82</span>      <span class="token number">417.96</span>       <span class="token number">27.53</span>  <span class="token number">30227262</span>   <span class="token number">1990625</span>
sda1    <span class="token number">6.55</span>      <span class="token number">219.10</span>        <span class="token number">7.12</span>  <span class="token number">15845129</span>    <span class="token number">515216</span>
sda2    <span class="token number">0.04</span>        <span class="token number">0.74</span>        <span class="token number">3.31</span>     <span class="token number">53506</span>    <span class="token number">239328</span>
sda3    <span class="token number">3.24</span>      <span class="token number">198.12</span>       <span class="token number">17.09</span>  <span class="token number">14328323</span>   <span class="token number">1236081</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>&emsp;&emsp;首先看到的是与top命令相似的CPU信息，下面紧跟着系统上所有硬盘设备及其分区的I/O状态信息。下面是各列代表的意义:  </p>
<ul>
<li><input disabled="" type="checkbox"> tps<br>这个值列出了设备每秒的传输量。”传输”（Transfer）是向设备发送I/O请求的另一种表达方式。  </li>
<li><input disabled="" type="checkbox"> Blk_read/s<br>表示每秒从设备读取的数据量。  </li>
<li><input disabled="" type="checkbox"> Blk_wrtn/s<br>表示每秒向设备写入的数据量。  </li>
<li><input disabled="" type="checkbox"> Blk_read<br>这一列表示从设备读取的数据总量。  </li>
<li><input disabled="" type="checkbox"> Blk_wrtn<br>这一列表示写入设备的数据总量。  </li>
</ul>
<p>&emsp;&emsp;当系统处于高I/O负载状态的时候，首先就是观察每个分区，看看哪个分区的I/O负载最高。比如说，你有一台数据库服务器，数据库本身存储在/dev/sda3分区。你如果看到大量的I/O操作来自这里，这就是一个很好的线索:数据库很可能占用了大量I/O资源。<br>&emsp;&emsp;弄明白了这一点后，下一步就是确定I/O操作大部分来自读取还是写入。假设你怀疑备份工作导致了I/O操作的增长。因为备份工作的操作主要集中于从文件系统中读取文件，然后通过网络传输到备用服务器，如果大量的I/O操作都来自于写入而不是读取操作，那么大概就可以排除这个问题。<br><strong>注意</strong><br>&emsp;&emsp;<em>你可能需要运行iostat命令多次，以此得到系统当前的精确I/O状况。如果在命令行指定一个数字参数，iostat就会持续运行并根据指定的秒数刷新输出信息。比如说，如果你想要每2秒看到一次iostat的输出，就可以输入sudo iostat 2。如果你有任何NFS共享，iostat另一个非常有用的参数是-n，当你指定了-n参数，iostat就会给出所有NFS共享的I/O统计信息。</em><br>&emsp;&emsp;除了iostat，在最新的发布版中，我们还有一个很简单的工具。实际上，它是top和iostat程序的混合体，能够显示系统中所有运行进程并将进程根据IO统计信息排序。这个软件使用了Linux内核的一些新特性，所以需要2.6.20或者更新的内核。如果默认情况下没有安装这个程序，那么可以在iotop包中找到它。这个工具包含在基于Debian的版本中，但是对于基于Red Hat的版本来说，你就需要在网上或者从第三方仓库中寻找并安装第三方的RPM。安装了这个包后，就可以用root权限运行iotop，并看到如下输出:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sudo</span> iotop
Total DISK READ: <span class="token number">189.52</span> K/s <span class="token operator">|</span> Total DISK WRITE: <span class="token number">0.00</span> B/s
 TID  PRIO  <span class="token environment constant">USER</span>  DISK  READ  DISK  WRITE   SWAPIN     I<span class="token operator"><span class="token file-descriptor important">0</span>></span>  COMMAND
<span class="token number">8159</span>  be/4  root <span class="token number">189.2</span>   K/s  <span class="token number">0.00</span>    B/s   <span class="token number">0.00</span> %  <span class="token number">0.00</span> %  <span class="token function">rsync</span> --server --se
 <span class="token number">443</span>  be/4  kyle  <span class="token number">0.00</span>   B/s  <span class="token number">3.79</span>    K/s   <span class="token number">0.00</span> %  <span class="token number">0.00</span> %  cli /usr/lib/gnome-
<span class="token number">4244</span>  be/4  kyle  <span class="token number">0.00</span>   B/s  <span class="token number">3.79</span>    K/s   <span class="token number">0.00</span> %  <span class="token number">0.00</span> %  cli /usr/lib/gnome-
   <span class="token number">1</span>  be/4  root  <span class="token number">0.00</span>   B/s  <span class="token number">0.00</span>    B/s   <span class="token number">0.00</span> %  <span class="token number">0.00</span> %  init
在这个例子中，你会看到rsync进程执行了大量I/O读取操作。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-3-问题发生后的高负载处理"><a href="#2-3-问题发生后的高负载处理" class="headerlink" title="2.3 问题发生后的高负载处理"></a>2.3 问题发生后的高负载处理</h2><p>&emsp;&emsp;截止到这里，本章都在讨论当系统负载过高的时候，如何找到高负载的原因。尽管top和 iostat都是非常优秀的工具，但是当系统发生问题的时候，我们不是总能足够幸运地找到解决办法。我记不清我遇到过多少次机器运行缓慢，只能等待负载降低才能登录。只需要稍微多做一点工作，就能在服务器上安装相应的工具，记录全天的性能数据。<br>&emsp;&emsp;我们已经讨论了如何使用sysstat包中的iostat工具来解决高I/O的问题，不过sysstat中也包含一些能报告CPU和RAM使用情况的工具。虽然的确可以使用top命令达到这个目的，但是sysstat更加强大，它能够用一种简单的机制来记录系统的统计信息，如CPU负载、RAM以及I/O状态。借助这些统计信息，当有人抱怨昨天中午系统很慢时，你就可以查看日志，看看是什么原因引起的这个问题。</p>
<h3 id="2-3-1-配置sysstat"><a href="#2-3-1-配置sysstat" class="headerlink" title="2.3.1 配置sysstat"></a>2.3.1 配置sysstat</h3><p>&emsp;&emsp;第一步是使用包管理工具安装sysstat包。在基于Debian的系统（如Ubuntu）中，sysstat不会自动启用，所以需要修改<code>/etc/default/sysstat</code>文件，将<br>&emsp;&emsp;<code>ENABLED=&quot;false&quot;</code><br>&emsp;&emsp;更改为<br>&emsp;&emsp;<code>ENABLED=&quot;true&quot;</code><br>&emsp;&emsp;在基于Red Hat的系统上，你可能需要修改<code>/etc/sysconfig/sysstat</code>文件，更改HISTORY选项，让它可以记录7天以上的统计信息。对于这两种系统，统计信息都可以每10分钟抓取一次并记录每日总结。<br>&emsp;&emsp;一旦启用了sysstat，它就会每10分钟收集一次系统状态并将它们存储到<code>/var/log/sysstat</code>或<code>/var/log/sa</code>文件中。除此之外，每天晚上在午夜之前，它还会分割统计文件。这些操作都是由<code>/etc/cron.d/sysstat</code>脚本执行的，所以如果想要更改sysstat收集信息的频率，你可以修改这个脚本文件。</p>
<h3 id="2-3-2-查看CPU统计信息"><a href="#2-3-2-查看CPU统计信息" class="headerlink" title="2.3.2 查看CPU统计信息"></a>2.3.2 查看CPU统计信息</h3><p>&emsp;&emsp;sysstat统计信息的时候，它将这些信息存储在以sa开头、以本月当前日期结尾的文件名的文件中（如sa03）。这就意味着你可以查看从当前日期起，一个月以内的统计数据。使用sar工具可以查看这些统计信息。默认情况下sar会输出当天的CPU统计信息:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ sar
Linux <span class="token number">2.6</span>.24-22-server <span class="token punctuation">(</span>kickseed<span class="token punctuation">)</span>01/07/2012
<span class="token punctuation">..</span>.
07:44:20 PM CPU %user %nice %system %iowait %steal %idle
07:45:01 PM all  <span class="token number">0.00</span>  <span class="token number">0.00</span>    <span class="token number">0.54</span>    <span class="token number">0.51</span>   <span class="token number">0.00</span> <span class="token number">98.95</span>
07:55:01 PM all  <span class="token number">0.54</span>  <span class="token number">0.00</span>    <span class="token number">1.66</span>    <span class="token number">1.26</span>   <span class="token number">0.00</span> <span class="token number">96.54</span>
08:05:01 PM all  <span class="token number">0.20</span>  <span class="token number">0.00</span>    <span class="token number">0.72</span>    <span class="token number">1.08</span>   <span class="token number">0.00</span> <span class="token number">98.00</span>
08:15:01 PM all  <span class="token number">0.49</span>  <span class="token number">0.00</span>    <span class="token number">1.12</span>    <span class="token number">0.62</span>   <span class="token number">0.00</span> <span class="token number">97.77</span>
08:25:01 PM all  <span class="token number">0.49</span>  <span class="token number">0.00</span>    <span class="token number">2.15</span>    <span class="token number">1.21</span>   <span class="token number">0.00</span> <span class="token number">96.16</span>
08:35:01 PM all  <span class="token number">0.22</span>  <span class="token number">0.00</span>    <span class="token number">0.98</span>    <span class="token number">0.58</span>   <span class="token number">0.00</span> <span class="token number">98.23</span>
08:45:01 PM all  <span class="token number">0.23</span>  <span class="token number">0.00</span>    <span class="token number">0.75</span>    <span class="token number">0.54</span>   <span class="token number">0.00</span> <span class="token number">98.47</span>
08:55:01 PM all  <span class="token number">0.20</span>  <span class="token number">0.00</span>    <span class="token number">0.78</span>    <span class="token number">0.50</span>   <span class="token number">0.00</span> <span class="token number">98.52</span>
09:01:18 PM all  <span class="token number">0.19</span>  <span class="token number">0.00</span>    <span class="token number">0.72</span>    <span class="token number">0.37</span>   <span class="token number">0.00</span> <span class="token number">98.71</span>
09:05:01 PM all  <span class="token number">0.24</span>  <span class="token number">0.00</span>    <span class="token number">1.10</span>    <span class="token number">0.54</span>   <span class="token number">0.00</span> <span class="token number">98.12</span>
Average:    all  <span class="token number">0.32</span>  <span class="token number">0.00</span>    <span class="token number">1.12</span>    <span class="token number">0.78</span>   <span class="token number">0.00</span> <span class="token number">97.78</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>&emsp;&emsp;从输出中可以发现，CPU的很多统计信息都和top命令的输出相同。在最后一行，sar还为每个值提供了平均值。</p>
<h3 id="2-3-3-查看RAM统计信息"><a href="#2-3-3-查看RAM统计信息" class="headerlink" title="2.3.3 查看RAM统计信息"></a>2.3.3 查看RAM统计信息</h3><p>&emsp;&emsp;sysstat计划任务不仅可以收集CPU负载信息，还能收集很多别的信息。例如，使用-r选项就可以收集RAM的统计信息:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ sar -r
Linux <span class="token number">2.6</span>.24-22-server <span class="token punctuation">(</span>kickseed<span class="token punctuation">)</span> 01/07/2012
07:44:20 PM kbmemfree kbmemused %memused kbbuffers kbcached kbswpfree kbswpused %swpused kbswpcad
07:45:01 PM    <span class="token number">322064</span>    <span class="token number">193384</span>    <span class="token number">37.52</span>     <span class="token number">16056</span>   <span class="token number">142900</span>     <span class="token number">88316</span>         <span class="token number">0</span>     <span class="token number">0.00</span>        <span class="token number">0</span> 
07:55:01 PM    <span class="token number">318484</span>    <span class="token number">196964</span>    <span class="token number">38.21</span>     <span class="token number">17152</span>   <span class="token number">144672</span>     <span class="token number">88316</span>         <span class="token number">0</span>     <span class="token number">0.00</span>        <span class="token number">0</span> 
08:05:01 PM    <span class="token number">318228</span>    <span class="token number">197220</span>    <span class="token number">38.26</span>     <span class="token number">17648</span>   <span class="token number">144700</span>     <span class="token number">88316</span>         <span class="token number">0</span>     <span class="token number">0.00</span>        <span class="token number">0</span>
08:15:01 PM    <span class="token number">297669</span>    <span class="token number">217780</span>    <span class="token number">42.25</span>     <span class="token number">18384</span>   <span class="token number">154408</span>     <span class="token number">88316</span>         <span class="token number">0</span>     <span class="token number">0.00</span>        <span class="token number">0</span>
08:25:01 PM    <span class="token number">284152</span>    <span class="token number">231296</span>    <span class="token number">44.87</span>     <span class="token number">28072</span>   <span class="token number">173724</span>     <span class="token number">88316</span>         <span class="token number">0</span>     <span class="token number">0.00</span>        <span class="token number">0</span>
08:35:01 PM    <span class="token number">283096</span>    <span class="token number">232352</span>    <span class="token number">45.08</span>     <span class="token number">20612</span>   <span class="token number">173756</span>     <span class="token number">88316</span>         <span class="token number">0</span>     <span class="token number">0.00</span>        <span class="token number">0</span>
08:45:01 PM    <span class="token number">283284</span>    <span class="token number">232164</span>    <span class="token number">45.04</span>     <span class="token number">21116</span>   <span class="token number">173780</span>     <span class="token number">88316</span>         <span class="token number">0</span>     <span class="token number">0.00</span>        <span class="token number">0</span>
08:55:01 PM    <span class="token number">282556</span>    <span class="token number">232892</span>    <span class="token number">45.18</span>     <span class="token number">21624</span>   <span class="token number">173804</span>     <span class="token number">88316</span>         <span class="token number">0</span>     <span class="token number">0.00</span>        <span class="token number">0</span>
09:01:18 PM    <span class="token number">276632</span>    <span class="token number">238816</span>    <span class="token number">46.33</span>     <span class="token number">21964</span>   <span class="token number">173896</span>     <span class="token number">88316</span>         <span class="token number">0</span>     <span class="token number">0.00</span>        <span class="token number">0</span>
09:05:01 PM    <span class="token number">281876</span>    <span class="token number">233572</span>    <span class="token number">45.31</span>     <span class="token number">22188</span>   <span class="token number">173900</span>     <span class="token number">88316</span>         <span class="token number">0</span>     <span class="token number">0.00</span>        <span class="token number">0</span>
Average:       <span class="token number">294804</span>    <span class="token number">220644</span>    <span class="token number">42.81</span>     <span class="token number">19682</span>   <span class="token number">162954</span>     <span class="token number">88316</span>         <span class="token number">0</span>     <span class="token number">0.00</span>        <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>&emsp;&emsp;在这里可以看到使用了多少内存，空闲多少内存，同时还能查看交换空间的信息以及文件缓存的信息，这些信息与用top或free命令输出的信息类似。与之不同的是，你可以及时查看之前的信息。</p>
<h3 id="2-3-4-查看磁盘统计信息"><a href="#2-3-4-查看磁盘统计信息" class="headerlink" title="2.3.4 查看磁盘统计信息"></a>2.3.4 查看磁盘统计信息</h3><p>&emsp;&emsp;从sar中还可以获得另一个非常有用的度量指标:磁盘统计信息。使用-b选项能给出一些列磁盘I/O的基本信息。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ sar -b
Linux <span class="token number">2.6</span>.24-22-server <span class="token punctuation">(</span>kickseed<span class="token punctuation">)</span> 01/07/2012
07:44:20 PM  tps rtps wtps bread/s bwrtn/s
07:45:01 PM <span class="token number">8.03</span> <span class="token number">0.00</span> <span class="token number">8.03</span>    <span class="token number">0.00</span>  <span class="token number">106.61</span>
07:55:01 PM <span class="token number">8.78</span> <span class="token number">0.14</span> <span class="token number">8.64</span>    <span class="token number">3.35</span>  <span class="token number">127.59</span>
08:05:01 PM <span class="token number">7.16</span> <span class="token number">0.00</span> <span class="token number">7.16</span>    <span class="token number">0.00</span>   <span class="token number">61.14</span>
08:15:01 PM <span class="token number">8.17</span> <span class="token number">0.14</span> <span class="token number">8.03</span>    <span class="token number">5.82</span>  <span class="token number">139.02</span>
08:25:01 PM <span class="token number">9.50</span> <span class="token number">0.06</span> <span class="token number">9.44</span>    <span class="token number">4.09</span>  <span class="token number">212.62</span>
08:35:01 PM <span class="token number">8.27</span> <span class="token number">0.00</span> <span class="token number">8.27</span>    <span class="token number">0.01</span>   <span class="token number">74.66</span>
08:45:01 PM <span class="token number">8.04</span> <span class="token number">0.00</span> <span class="token number">8.04</span>    <span class="token number">0.00</span>   <span class="token number">71.51</span>
08:55:01 PM <span class="token number">7.64</span> <span class="token number">0.00</span> <span class="token number">7.64</span>    <span class="token number">0.00</span>   <span class="token number">66.46</span>
09:01:18 PM <span class="token number">7.11</span> <span class="token number">0.00</span> <span class="token number">7.11</span>    <span class="token number">0.36</span>   <span class="token number">63.73</span>
09:05:01 PM <span class="token number">7.61</span> <span class="token number">0.00</span> <span class="token number">7.61</span>    <span class="token number">0.00</span>   <span class="token number">72.11</span>
Average:    <span class="token number">8.11</span> <span class="token number">0.04</span> <span class="token number">8.06</span>    <span class="token number">1.67</span>  <span class="token number">102.52</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>&emsp;&emsp;从这里可以看到每秒总共传输的数据量（ tps），它由总共读取的数据量和写入的数据量（分别是rtps和 wtps）相加获得。bread/s列并非用来衡量块IO，而是告诉你平均每秒读取的数据量。类似地、bwrtn/s能告诉你平均每秒写入的数据量。<br>&emsp;&emsp;sar程序可以传入很多参数，输出特定的数据集，不过有的时候你可能想一次性看到所有数据。使用-A选项可以做到这点。它会显示包括负载平均值、CPU负载、RAM、磁盘IO、网络IO和其他一些有趣值在内的统计信息。这样可以让你更加了解sar能够输出什么统计信息，之后，通过阅读sar的用户手册(输入man sar).可以了解到想要看特定的统计信息应该传入什么标志位。</p>
<h3 id="2-3-5-查看之前的统计信息"><a href="#2-3-5-查看之前的统计信息" class="headerlink" title="2.3.5 查看之前的统计信息"></a>2.3.5 查看之前的统计信息</h3><p>&emsp;&emsp;当然，到目前为止，我仅仅介绍了如何查看整天的信息。有时你会只想查看一天中部分时间段内的信息。想要获得指定时间范围内的信息，可以使用-s和-e参数分别指定你感兴趣的开始时间和结束时间。例如，如果想要查看8:00pm—8:30pm这个时间段内的CPU数据，需要输入:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ sar -s <span class="token number">20</span>:00:00 -e <span class="token number">20</span>:30:00
Linux <span class="token number">2.6</span>.24-22-server <span class="token punctuation">(</span>kickseed<span class="token punctuation">)</span>01/07/2012
08:05:01 PM CPU %user %nice %system %iowait %steal %idle
08:15:01 PM all  <span class="token number">0.49</span>  <span class="token number">0.00</span>    <span class="token number">1.12</span>    <span class="token number">0.62</span>   <span class="token number">0.00</span> <span class="token number">97.77</span>
08:25:01 PM all  <span class="token number">0.49</span>  <span class="token number">0.00</span>    <span class="token number">2.15</span>    <span class="token number">1.21</span>   <span class="token number">0.00</span> <span class="token number">96.16</span>
Average:    all  <span class="token number">0.49</span>  <span class="token number">0.00</span>    <span class="token number">1.63</span>    <span class="token number">0.91</span>   <span class="token number">0.00</span> <span class="token number">96.96</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>&emsp;&emsp;如果想要获取非当天的数据，使用-f选项，后面输入存储在<code>/var/log/sysstat</code>或<code>/var/log/sa</code>文件夹内统计信息文件的完整路径。例如，想要获取本月第6天的统计信息，你需要输入:<br><code>$ sar -f /var/1og/sysstat/sa06</code><br>&emsp;&emsp;也可以正常混合使用任意其他sar选项，从而获得特定类型的统计信息。</p>
<h1 id="系统启动问题"><a href="#系统启动问题" class="headerlink" title="系统启动问题"></a>系统启动问题</h1><p>&emsp;&emsp;Linux系统可能会出很多问题，其中最让人感到崩溃的也许就是系统无法启动了。毕竟，服务器系统无法启动就意味着它停止了所有服务，直到这个问题得到解决为止。更重要的是，你想要获取的任何数据可能都依赖于系统备份和运行的能力。<br>&emsp;&emsp;有很多问题都可能会导致系统无法启动。为了让大家更好地查明系统为什么无法启动，本章首先会介绍启动过程。一旦明白了系统启动的流程，你就可以观察自己的系统，看看它卡在了哪一步。讲完启动流程之后，本章还会强调几类主要的启动问题，以及如何诊断并修复这些问题。<br>&emsp;&emsp;从传统意义上讲，处理启动问题是系统管理员的工作，不过，任何DevOps团队中的成员都有责任让系统中的软件包保持最新状态。当内核或者发行版的更新出现问题的时候，你自己就能够让系统恢复正常再好不过。</p>
<h2 id="3-1-Linux启动流程"><a href="#3-1-Linux启动流程" class="headerlink" title="3.1 Linux启动流程"></a>3.1 Linux启动流程</h2><p>&emsp;&emsp;第1章曾经提到过，如果你想要擅长故障排除工作，那么你最好清楚系统如何运行。这个道理也适用于处理启动问题，特别是因为有众多原因可以引发启动问题。</p>
<h3 id="3-1-1-BIOS"><a href="#3-1-1-BIOS" class="headerlink" title="3.1.1 BIOS"></a>3.1.1 BIOS</h3><p>&emsp;&emsp;启动过程中最先执行的程序是BIOS（基本输入输出系统）。系统启动的时候，首先会看到这个界面。尽管对于不同的系统来说，这个程序的界面不尽相同，但是BIOS都会初始化硬件，包括检测硬盘驱动器、USB磁盘、CD-ROM、网卡以及任何其他可以从中启动的硬件。然后BIOS会根据所配置的启动设备的顺序一步步检查，直到找到可以从中成功启动的设备。对于Linux服务器来说，这个过程通常意味着读取MBR（主引导记录，即硬盘上的前512字节）、载入并执行MBR中的启动代码，由此开始启动流程。</p>
<h3 id="3-1-2-GRUB和Linux启动载入程序"><a href="#3-1-2-GRUB和Linux启动载入程序" class="headerlink" title="3.1.2 GRUB和Linux启动载入程序"></a>3.1.2 GRUB和Linux启动载入程序</h3><p>&emsp;&emsp;BIOS将硬件初始化完毕，找到第一个可以启动的设备之后，启动载入程序将接管下面的工作。在一般的Linux服务器上，这个启动载入程序可能是GRUB，不过之前也有人用过一个名为LILO的程序。GRUB通常是系统从硬盘启动时需要用到的启动载入程序，当系统从USB、CD-ROM或网络启动的时候，分别会使用syslinux 、isolinux或pxelinux作为相应的启动载入程序。尽管syslinux及其他启动载入程序的细节与GRUB不尽相同，但是它们的功能都是载入各种软件并读取配置文件，从配置文件中能够得知启动什么操作系统，在哪里找到对应操作系统的内核以及当系统启动时应用什么样的配置。<br>&emsp;&emsp;当GRUB被载入之后，会在MBR中会执行一小部分代码（称之为第一阶段）。因为MBR中仅能容纳446字节的启动代码（其余部分用来保存分区表信息），这些代码仅仅够定位到其他代码，然后执行这些代码。GRUB代码的下一阶段可以让它访问Linux的文件系统、读取并载入配置文件，由此找出应该启动哪个操作系统和这些操作系统在硬盘的位置，以及应当传入哪些选项参数。对于Linux来说，这可能包含硬盘上很多不同的内核版本以及能帮助解决问题的特殊恢复模式。通常配置文件中也会描述可以用来查看并修改启动选项的各类菜单。<br>&emsp;&emsp;绝大多数现代操作系统中，GRUB都会显示一个非常友好的启动界面，有时带有一些图形，一般还会有一个倒计时。通常你会看到一个菜单，上面有一个可以选择启动哪个操作系统的列表（见图），不过有时需要按下类似于Esc的按键（在GRUB2中要按下Shift键）才能看到这个菜单。GRUB也允许查看和修改指定的启动时间设置，这一点在进行问题处理的时候非常方便，因为你可以在没有恢复盘的情况下，修正可能存在于GRUB配置文件中的错误。</p>
<p><img src="/medias/drawing-bed/oops/1.jpg"></p>
<h3 id="3-1-3-内核与初始RAM磁盘"><a href="#3-1-3-内核与初始RAM磁盘" class="headerlink" title="3.1.3 内核与初始RAM磁盘"></a>3.1.3 内核与初始RAM磁盘</h3><p>&emsp;&emsp;一旦在GRUB中选择了特定的内核（或者倒计时结束，系统会自动为你做出选择），GRUB会将Linux核心载入到RAM中并执行，同时传入启动时配置的所有参数。通常GRUB也会随着内核载入初始RAM磁盘（InitialRAM Disk，Initrd）。在现代Linux系统中，它通常是gzip格式压缩的备份文档，称为initramfs文件，一般包含一个基本的小型Linux根文件系统。在这个文件系统中，有一些重要的配置文件、内核模块以及内核需要用来寻找并挂载（mount）真实根文件系统的程序。<br>&emsp;&emsp;以前，启动时的这些功能都直接构建在 Linux内核中。但是，随着硬件开始支持很多不同类型的文件系统以及SCSI和IDE设备，并带有一些额外特性（如RAID、LVM和文件系统加密），内核变得越来越大。因此，这些特性被分拆到独立的模块中，这样就可以仅仅载入系统需要的模块。因为硬件驱动器和文件系统支持都分拆到了模块中，所以你会面临鸡和蛋的问题。如果模块处于根文件系统中，而你又需要用这些模块来读取根文件系统，怎样才能完成挂载?解决方法就是将这些重要的模块都放入初始RAM磁盘中。<br>&emsp;&emsp;随着内核的启动，它会将initramfs文件解压到RAM中，然后在initramfs文件的根目录中运行一段名为init的脚本。这仅仅是一段标准的shell脚本，用来先检测硬件，然后创建挂载点，之后再挂载根文件系统。因为这个路径是由GRUB在它首次加载内核的时候传入的一个启动参数（root=），所以系统内核知道根文件系统在哪里。在挂载了真正的根文件系统之后，initramfs文件的最后一步是执行<code>/sbin/init</code>程序，后者会接管启动流程中其余的工作。</p>
<h3 id="3-1-4-sbin-init"><a href="#3-1-4-sbin-init" class="headerlink" title="3.1.4 /sbin/init"></a>3.1.4 /sbin/init</h3><p>&emsp;&emsp;<code>/sbin/init</code>程序是系统中所有程序的父进程。这个进程的PID总是1，它负责启动组成Linux操作系统的其他进程。那些使用过一段时间Linux操作系统的用户都知道，Ubuntu服务器上的init程序与大家之前习惯使用的init程序不同。它们在如何初始化UNIX操作系统方面有一些不同的标准，但是绝大多数传统Linux发行版都使用著名的System V init模型（马上就会讲到），然而一些现代Linux发行版选择使用其他系统，如Upstart，或者最近的systemd例如，Ubuntu服务器选择使用Upstart，但它仍然保留了System V init程序的杰出结构，如运行等级（runlevel）和针对向后兼容的letc/rc?.d文件夹，而且 Upstart现在开始处理底层所有的工作。因为服务器上最常使用的两种init系统是Sytem V init和Upstart，所以下面就分别介绍它们。  </p>
<ol>
<li>传统的 System V lnit</li>
</ol>
<p>&emsp;&emsp;System V指的是由AT&amp;T开发的原始UNIX操作系统中的一个特定版本。在这种风格的init程序中，init进程会读取<code>/etc/inittab</code>的配置文件，通过它来查看默认的运行等级，下面会讨论到这点。然后进入这个运行等级，启动配置在这个运行等级下应该启动的进程。<br>&emsp;&emsp;System V init进程由很多称为运行等级的不同系统状态定义。运行等级用数字区分，从0到6，每个数字代表了一个完全不同的系统状态。例如，运行等级0留给了停止的系统状态。当你进入运行等级0，系统就会终止所有的运行进程，卸载所有的文件系统并断电。类似地，运行等级6代表重启机器。运行等级1代表单用户模式——仅有单个用户可以登录到系统中的状态。通常，没有几个进程能在单用户模式下启动，所以这个运行等级在处理系统无法完全启动的问题上非常有用。在默认的GRUB菜单中能看到一个恢复模式，它会启动进入运行等级为1的系统状态中。<br>&emsp;&emsp;运行等级2到5留给发行版使用，最终由用户来定义。定义诸多运行等级的想法是让你创建进入服务器的不同模式。很多Linux发行版都会为图形桌面设置一个运行等级（在Red Hat中，为运行等级5），并为非图形界面设置另一个运行等级（在Red Hat中，为运行等级3），这是一个传统的做法。你也可以定义其他的运行等级，例如，为启动不带网络访问的系统定义一个运行等级。然后在启动的时候，根据提示输入一个参数，用你指定的运行等级覆盖默认的运行等级。系统启动之后，你也可以用init命令后跟着运行等级的方式更改当前的运行等级。所以，想要更改为单用户模式，应该输入sudo init 1。<br>&emsp;&emsp;除了/etc/inittab，对于System V init系统启动和关闭脚本或者初始化脚本，以及系统的主要服务来说，还有很多其他重要的文件和文件夹。  </p>
<ul>
<li><input disabled="" type="checkbox"> /etc/init.d<br>该文件夹包含所有服务在各个运行等级中的全部启动脚本。一般来说，它们都是标准的shell脚本，遵守最基本的标准。每个脚本最少接受两个参数start和stop，它们分别代表启动和停止服务（如网页服务）。除此之外，init脚个通常还会接受一些额外的选项，如restart（重启服务器）、status（返回服务当前状态）、reload（告知服务从配置文件中重新载入配置）以及force-reload（强制服务重载它的配置）。当用不带参数的方式运行脚本的时候，一般应该返回一个它会接受的参数列表。  </li>
<li><input disabled="" type="checkbox"> /etc/rc0.d ~ /etc/rc6.d<br>这些文件夹分别包含每个运行等级对应的init脚本。在实际使用中，它们一般通过符号链接到/etc/init.d文件夹下的实际文件。不过要注意的是，这些文件卖下的init脚本都有一些特别的名字，命名都以S（start）、K（kill）或D（disable）开头，后面跟一个数字。当init进人一个运行等级的时候，它会按照数字顺序运行所有以K开头的脚本并传人stop参数，除非对应的init脚本在前一个运行等级中没有启动。然后init按照数字顺序运行所有以S开头的脚本并传人start参数。任何以D开头的init脚本都会被忽略——这让你可以在指定的运行等级禁止一个脚本，或者你也可以仅仅移除全部符号链接。所以如果你有两个脚本，S01foo和S05bar，init首先会运行S01foo start，当它进人特定的运行等级后再执行S05bar start。  </li>
<li><input disabled="" type="checkbox"> /etc/rcS.d<br>在这个文件卖中，你会找到在变更到特定的运行等级之前，运行的所有系统init脚本。修改这个文件夹中的脚本时要小心，因为如果它们停止工作，你将无法进人单用户模式。  </li>
<li><input disabled="" type="checkbox"> /etc/rc.local<br>并非所有的发行版都使用了rc.local，通常它是一个留给用户修改的shell脚本。一般会在init进程结束的时候运行它，所以你可以在这里放一些想要运行的额外脚本，而不用再创建自己的init脚本。<br>&emsp;&emsp;这里有一个标准的System V init系统的启动过程。首先init启动并读取/etc/inittab文件以确定默认的运行等级，在这个例子中.运行等级为2。然后init进入/etc/rcS.d文件夹，按照数字顺序用start作为参数运行所有以S开头的脚本文件。然后init在/etc/rc2.d文件夹中做相同的工作。最后init执行完毕，但是还会在后台运行，等待运行等级的更改。</li>
</ul>
<ol start="2">
<li>Upstart</li>
</ol>
<p>&emsp;&emsp;System V init是一个非常优秀的系统，而且在Linux系统上也工作了很多年，不过，它并非完美无瑕。例如，当服务宕掉的时候，init脚本没有一个自动重启机制，你必须借助其他工具来监视和重启这些进程。<br>&emsp;&emsp;init脚本的另一个问题是它们通常仅受到根据运行等级更改或者系统启动的影响，除此之外，除非手动操作，这些脚本都不会运行。依赖网络连接的init脚本就是一个非常好的例子。在基于Red Hat和基于Debian系统中，名为network或networking 的init脚本分别用来建立网络连接。任何依赖于网络连接的init脚本与其他脚本相比都有一个很大的数字，这样才能保证网络脚本运行之后它们才运行。但是如果你拔掉服务器的网线，再启动会怎样呢?网络脚本还会执行，但是所有依赖网络连接的init脚本都会一个接一个地超时。最后你会得到一个登录提示并可以登录。等你登录之后，如果你插上网线，重启网络服务，你会连上网络，但是没有一个需要网络连接的服务会自动重启，你必须一个个地手动启动这些服务。<br>&emsp;&emsp;Upstart的设计初衷并不仅仅是为了弥补System V init的缺陷,而且还为了提供更加健壮的服务管理。Upstart的一大特性是它由事件驱动。Upstart持续监控系统中特定事件的发生，当这些事件发生的时候，Upstart就会基于这些事件做出相应的动作。事件可能是系统启动、系统关闭、按下Ctrl-Alt-Del组合键、运行等级更改或者Upstart脚本的启动或停止。要弄清楚事件驱动的系统如何改进了传统的init脚本，让我们以前面拔下网线启动服务器为例。你可以创建一个Upstart脚本，当插人网线的时候会触发这个脚本。接着，这个脚本会为你启动网络服务。然后，当网络服务成功启动之后，你就可以配置触发任何需要网络连接的服务。现在当系统启动的时候，插上网线即可，Upstart脚本会帮你完成剩下的工作。<br>&emsp;&emsp;Upstart并没有完全替代System V init，至少对于系统服务来说没能完全替代。目前，Upstart的确替代了int和/etc/inittab文件的功能，它管理运行等级的更改、系统启动和关闭以及控制ttysoUpstart脚本中移植了越来越多的功能，但是你仍然会在/etc/init.d中找到部分标准的init脚本，所有标准的symlink都在letc/rc?.d文件夹中。不同的是，当运行等级更改的时候，Upstart会开启或者停<br>止服务。<br>&emsp;&emsp;Upstart脚本在/etclinit文件夹中，它们与init脚本的区别很大，因为它们不是常规的shell脚本。为了帮助解释它的语法，下面是一个Upstart脚本(/etc/init/rc.conf）的例子，在运行等级更改的时候会触发这个脚本。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#rc - System V runlevel compatibility</span>
<span class="token comment">#</span>
<span class="token comment"># This task runs the old Systen V-style rc script when changing</span>
<span class="token comment">#between runleve1s.</span>
<span class="token string">"System V runlevel compatibility"</span>
description
author
<span class="token string">"Scott James Remnant &lt;scott@netsplit.com>"</span>
start on runleve1 <span class="token punctuation">[</span>0123456<span class="token punctuation">]</span>
stop on runleve1<span class="token punctuation">[</span> <span class="token operator">!</span>SRUNLEVEL<span class="token punctuation">]</span>
<span class="token builtin class-name">export</span> RUNLEVEL
<span class="token builtin class-name">export</span> PREVLEVEL
task
<span class="token builtin class-name">exec</span> /etc/init.d/rc <span class="token variable">$RUNLEVEL</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="磁盘满、磁盘损坏问题"><a href="#磁盘满、磁盘损坏问题" class="headerlink" title="磁盘满、磁盘损坏问题"></a>磁盘满、磁盘损坏问题</h1><h1 id="服务器宕机、网络问题"><a href="#服务器宕机、网络问题" class="headerlink" title="服务器宕机、网络问题"></a>服务器宕机、网络问题</h1><h1 id="DNS服务器问题"><a href="#DNS服务器问题" class="headerlink" title="DNS服务器问题"></a>DNS服务器问题</h1><h1 id="邮件问题"><a href="#邮件问题" class="headerlink" title="邮件问题"></a>邮件问题</h1><h1 id="Web服务器问题"><a href="#Web服务器问题" class="headerlink" title="Web服务器问题"></a>Web服务器问题</h1><h1 id="MySQL数据库问题"><a href="#MySQL数据库问题" class="headerlink" title="MySQL数据库问题"></a>MySQL数据库问题</h1><h1 id="硬件问题"><a href="#硬件问题" class="headerlink" title="硬件问题"></a>硬件问题</h1><p>如果您有 补充 &amp; 更正 的意见和建议请留言评论，谢谢~</p>


            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Poyais</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://roxn.cn/posts/f80c.html">https://roxn.cn/posts/f80c.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Poyais</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/linux/">
                                    <span class="chip bg-color">linux</span>
                                </a>
                            
                                <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
                                    <span class="chip bg-color">学习笔记</span>
                                </a>
                            
                                <a href="/tags/%E7%B3%BB%E7%BB%9F/">
                                    <span class="chip bg-color">系统</span>
                                </a>
                            
                                <a href="/tags/devops/">
                                    <span class="chip bg-color">devops</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,wechat,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>

        </div>
    </div>

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/42ea.html">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/medias/drawing-bed/featureimages/44.jpg" class="responsive-img" alt="nginx反向代理gitlab">
                        
                        <span class="card-title">nginx反向代理gitlab</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            配置主机nginx反向代理gitlab
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-09-14
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/linux/" class="post-category">
                                    linux
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
                        <span class="chip bg-color">学习笔记</span>
                    </a>
                    
                    <a href="/tags/nginx/">
                        <span class="chip bg-color">nginx</span>
                    </a>
                    
                    <a href="/tags/gitlab/">
                        <span class="chip bg-color">gitlab</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/dad9.html">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/medias/drawing-bed/featureimages/47.jpg" class="responsive-img" alt="mycat使用">
                        
                        <span class="card-title">mycat使用</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            mycat + mysql
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-08-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/linux/" class="post-category">
                                    linux
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/linux/">
                        <span class="chip bg-color">linux</span>
                    </a>
                    
                    <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
                        <span class="chip bg-color">学习笔记</span>
                    </a>
                    
                    <a href="/tags/mysql/">
                        <span class="chip bg-color">mysql</span>
                    </a>
                    
                    <a href="/tags/mycat/">
                        <span class="chip bg-color">mycat</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Roxn<br />'
            + '文章作者: Poyais<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


    <footer class="page-footer bg-color">

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2020-2021</span>
            

            
                <span id="icp"><img src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/medias/icp.png"
                                    style="vertical-align: text-bottom;"/>
                <a href="https://beian.miit.gov.cn" target="_blank">京ICP备20015925号</a>
            </span>
            
            <br>

<!--             <span id="year">2020</span>
            <a href="/about" target="_blank">Poyais</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br> -->


            <!-- 运行天数提醒. -->
            <span <i class="fas fa-desktop"></i> </span>
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    function siteTime() {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2020";
                        var startMonth = "8";
                        var startDate = "1";
                        var startHour = "8";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);
                        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
                        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '小破站已勉强苟活 ' + diffDays + ' 天 ' + diffHours + ' 小时 ' + diffMinutes + ' 分钟 ' + diffSeconds + ' 秒🎊';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '小破站已勉强苟活 ' + diffYears + ' 年 ' + diffDays + ' 天 ' + diffHours + ' 小时 ' + diffMinutes + ' 分钟 ' + diffSeconds + ' 秒🎊';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    setInterval(siteTime, 1000);
                </script>
            <br>
            
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点字数:&nbsp;<span
                        class="white-color">153.9k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">🎉
                <i class="far fa-eye"></i>&nbsp;访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">🎉
                <i class="fas fa-users"></i>&nbsp;访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>🎉
            </span>
            


        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的Git仓库" data-position="top" data-delay="50">
        <i class="fab fa-git"></i>
    </a>



    <a href="mailto:158970251@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=158970251" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 158970251" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="https://cdn.jsdelivr.net/gh/jroxn/jroxn.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
